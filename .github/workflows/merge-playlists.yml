name: Ultimate Playlist Merge (Fast)

on:
  push:
    paths:
      - 'localnetwork/my_playlist.m3u'
  schedule:
    - cron: '*/2 * * * *'   # ⏱ Runs every 2 minutes
  workflow_dispatch:

jobs:
  merge:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Download External Playlists
        run: |
          set -e
          echo "⬇️ Downloading external playlists..."

          # SonyLIV events first
          curl -fsSL "https://raw.githubusercontent.com/drmlive/sliv-live-events/main/sonyliv.m3u" -o external_sonyliv.m3u

          curl -fsSL "https://raw.githubusercontent.com/alex8875/m3u/main/jstar.m3u" -o external_jstar.m3u
          curl -fsSL "https://raw.githubusercontent.com/drmlive/fancode-live-events/main/fancode.m3u" -o external_fancode.m3u
          curl -fsSL "https://raw.githubusercontent.com/abid58b/WillowLivePlaylist/main/willowlive.m3u" -o external_willow.m3u
          curl -fsSL "https://raw.githubusercontent.com/alex8875/m3u/main/z5.m3u" -o external_z5.m3u
          curl -fsSL "https://raw.githubusercontent.com/himanshu-temp/m3u/main/sony.m3u" -o external_sony.m3u

      - name: Merge Playlists
        run: |
          echo "#EXTM3U" > merged_playlist.m3u

          # SonyLIV events at the top
          [ -f external_sonyliv.m3u ] && echo "# --- SonyLIV Playlist ---" >> merged_playlist.m3u && cat external_sonyliv.m3u >> merged_playlist.m3u

          # Other external playlists
          [ -f external_jstar.m3u ] && echo "# --- JStar Playlist ---" >> merged_playlist.m3u && cat external_jstar.m3u >> merged_playlist.m3u
          [ -f external_fancode.m3u ] && echo "# --- Fancode Playlist ---" >> merged_playlist.m3u && cat external_fancode.m3u >> merged_playlist.m3u
          [ -f external_willow.m3u ] && echo "# --- Willow Playlist ---" >> merged_playlist.m3u && cat external_willow.m3u >> merged_playlist.m3u
          [ -f external_z5.m3u ] && echo "# --- Z5 Playlist ---" >> merged_playlist.m3u && cat external_z5.m3u >> merged_playlist.m3u
          [ -f external_sony.m3u ] && echo "# --- Sony Playlist ---" >> merged_playlist.m3u && cat external_sony.m3u >> merged_playlist.m3u

          # Local playlist at the end
          [ -f localnetwork/my_playlist.m3u ] && echo "# --- Local Playlist ---" >> merged_playlist.m3u && cat localnetwork/my_playlist.m3u >> merged_playlist.m3u

          echo "✅ Merge complete."

      - name: Commit if Updated
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          if [ -f merged_playlist.m3u ]; then
            git add merged_playlist.m3u

            if ! git diff --cached --quiet; then
              echo "📝 Changes detected. Committing updated playlist..."
              git fetch origin main
              git rebase origin/main
              git commit -m "Fast auto-merge playlists (every 2 min)"
              git push origin main
            else
              echo "ℹ️ No changes detected in merged_playlist.m3u"
            fi
          else
            echo "⚠️ merged_playlist.m3u does not exist!"
            exit 1
