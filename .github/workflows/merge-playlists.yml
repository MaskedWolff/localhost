name: Ultimate Playlist Merge (Fast)

on:
  push:
    paths:
      - 'localnetwork/my_playlist.m3u'
  schedule:
    - cron: '*/2 * * * *'   # ⏱ Runs every 2 minutes
  workflow_dispatch:

jobs:
  merge:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Download External Playlists
        run: |
          set -e
          echo "⬇️ Downloading external playlists..."
          curl -fsSL "https://raw.githubusercontent.com/alex8875/m3u/refs/heads/main/jstar.m3u" -o external_jstar.m3u || echo "⚠️ JStar failed"
          curl -fsSL "https://raw.githubusercontent.com/drmlive/fancode-live-events/main/fancode.m3u" -o external_fancode.m3u || echo "⚠️ Fancode failed"
          curl -fsSL "https://raw.githubusercontent.com/alex8875/m3u/refs/heads/main/z5.m3u" -o external_z5.m3u || echo "⚠️ Z5 failed"
          curl -fsSL "https://raw.githubusercontent.com/himanshu-temp/m3u/refs/heads/main/sony.m3u" -o external_sony.m3u || echo "⚠️ Sony failed"
          curl -fsSL "https://raw.githubusercontent.com/drmlive/sliv-live-events/refs/heads/main/sonyliv.m3u" -o external_sonyliv.m3u || echo "⚠️ Sonyliv failed"

      - name: Merge Playlists
        run: |
          echo "#EXTM3U" > merged_playlist.m3u

          for f in external_jstar.m3u external_fancode.m3u external_z5.m3u external_sony.m3u external_sonyliv.m3u; do
            [ -f "$f" ] && grep -v '^#EXTM3U' "$f" >> merged_playlist.m3u
          done

          grep -v '^#EXTM3U' localnetwork/my_playlist.m3u >> merged_playlist.m3u
          echo "✅ Merge complete."

      - name: Remove Educational group channels
        run: |
          awk '
            BEGIN { skip=0 }
            /^#EXTINF/ {
              if ($0 ~ /group-title="?Educational"?/i) skip=1
              else skip=0
            }
            skip==0 { print }
          ' merged_playlist.m3u > temp.m3u && mv temp.m3u merged_playlist.m3u
          echo "✅ Educational group removed"

      - name: Add liv1 to Sony channels (safe)
        run: |
          sed -i '/#EXTINF/{
            /Sony/{
              /liv1/! s/$/ liv1/
            }
          }' merged_playlist.m3u
          echo "✅ liv1 added safely to Sony channels"

      - name: Commit if Updated
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add merged_playlist.m3u
          if ! git diff --cached --quiet; then
            git commit -m "Auto-merge playlists (Willow + Educational removed)"
            git pull origin main --rebase
            git push origin main
          else
            echo "ℹ️ No changes detected"
          fi
